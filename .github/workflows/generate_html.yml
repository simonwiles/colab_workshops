name: Generate Workshop HTML from Markdown

on: [push]

jobs:
  pre-check:
    runs-on: ubuntu-latest
    steps:
      - name: Pre-Check
        run: |
          export MDFILES=$(
            curl --silent https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }} | 
            jq --raw-output '.files[].filename | match(".*(?<!README)\\.md").string');

  generate-html:
    runs-on: ubuntu-latest
    if: ${{ env.MDFILES }}
    steps:
    - name: Checkout Workshops Repo
      uses: actions/checkout@v2
      with:
        path: workshops
    - name: Checkout HTML generator
      uses: actions/checkout@v2
      with:
        repository: simonwiles/workshop-html-generator
        path: html-generator
    - name: Install dependencies
      run: |
        cd html-generator
        python3 -m pip install --upgrade pip
        pip3 install setuptools
        pip3 install -r requirements.txt
    - name: Generate HTML
      run: |
        cd workshops
        for i in $MDFILES;
        do
          echo "Generating ${i%%.md}.html"; 
          python3 ../html-generator/gen_html.py -t ../html-generator/template.html "$i" > "${i%%.md}.html";
          git add "${i%%.md}.html";
        done;
    - name: Commit HTML
      run: |
        cd workshops
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        git commit -am "Auto-generated HTML"
        git push
